# üîç –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º–∏ MongoDB

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### ‚ùå –ü–†–û–ë–õ–ï–ú–ê (–ë–£–õ–û):

**–°–∏–º–ø—Ç–æ–º–∏:**
- 200-300 –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
- –ü–æ–º–∏–ª–∫–∏ ETIMEOUT
- MongoDB Alert: "Connections % above 80%"
- –ü–æ–≤—ñ–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞

**–ü—Ä–∏—á–∏–Ω–∞:**
–ö–æ–∂–µ–Ω API –∑–∞–ø–∏—Ç —Å—Ç–≤–æ—Ä—é–≤–∞–≤ **–ù–û–í–ï** –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:

```javascript
// ‚ùå –ü–û–ì–ê–ù–ò–ô –ö–û–î (–±—É–ª–æ –≤ 10 —Ñ–∞–π–ª–∞—Ö):
const client = await MongoClient.connect(MONGODB_URI);
const db = client.db(DB_NAME);
// ... —Ä–æ–±–æ—Ç–∞
await client.close(); // –ß–∞—Å—Ç–æ –Ω–µ –≤–∏–∫–æ–Ω—É–≤–∞–ª–æ—Å—å!
```

**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏:**
- 1 –∑–∞–ø–∏—Ç = 1 –Ω–æ–≤–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è (~600ms)
- 100 –∑–∞–ø–∏—Ç—ñ–≤ = 100 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
- 1000 –∑–∞–ø–∏—Ç—ñ–≤ = 1000 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å üò±
- –õ—ñ–º—ñ—Ç MongoDB Atlas Free Tier = 500 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å

---

## ‚úÖ –†–Ü–®–ï–ù–ù–Ø (–°–¢–ê–õ–û):

**Connection Pooling** - –ø—É–ª –∑ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥–∫–ª—é—á–µ–Ω—å:

```javascript
// ‚úÖ –•–û–†–û–®–ò–ô –ö–û–î (–∑–∞—Ä–∞–∑):
const { db } = await connectToDatabase(); // –ó –ø—É–ª—É
// ... —Ä–æ–±–æ—Ç–∞
// –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –≤ –ø—É–ª!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- 1 –∑–∞–ø–∏—Ç = 0 –Ω–æ–≤–∏—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω—å (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∑ –ø—É–ª—É)
- 100 –∑–∞–ø–∏—Ç—ñ–≤ = ~10 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å (maxPoolSize)
- 1000 –∑–∞–ø–∏—Ç—ñ–≤ = ~10 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å (maxPoolSize)
- –®–≤–∏–¥–∫—ñ—Å—Ç—å: –≤ 3 —Ä–∞–∑–∏ —à–≤–∏–¥—à–µ ‚ö°

---

## üß™ –¢–µ—Å—Ç–∏ (–∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏):

### –¢–µ—Å—Ç 1: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è 5 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å (—Å—Ç–∞—Ä–∏–π —Å–ø–æ—Å—ñ–±)
```
‚è±Ô∏è  –ß–∞—Å: 2966ms
üìä ~593ms –Ω–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
‚ùå –ü—Ä–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: 100-1000 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
```

### –¢–µ—Å—Ç 2: Connection Pool (–Ω–æ–≤–∏–π —Å–ø–æ—Å—ñ–±)
```
‚è±Ô∏è  –ß–∞—Å: 871ms
üìä –í—Å—ñ 5 –∑–∞–ø–∏—Ç—ñ–≤ —á–µ—Ä–µ–∑ 1 –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ –ø—É–ª—É
‚úÖ –ü—Ä–∏ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: 2-10 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
```

**–ï–∫–æ–Ω–æ–º—ñ—è:** 3.4x —à–≤–∏–¥—à–µ + –≤ 100x –º–µ–Ω—à–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω—å!

---

## üõ†Ô∏è –©–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:

### 1. –°—Ç–≤–æ—Ä–µ–Ω–æ `lib/mongodb.ts` –∑ pooling:
```typescript
const options = {
  maxPoolSize: 10,        // –ú–∞–∫—Å 10 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
  minPoolSize: 2,         // –ú—ñ–Ω 2 –∞–∫—Ç–∏–≤–Ω–∏—Ö
  maxIdleTimeMS: 30000,   // –ó–∞–∫—Ä–∏–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ 30—Å
  socketTimeoutMS: 45000, // –¢–∞–π–º–∞—É—Ç –æ–ø–µ—Ä–∞—Ü—ñ—ó
};

let cachedClient: MongoClient | null = null;

export async function connectToDatabase() {
  if (cachedClient) {
    return { client: cachedClient, db };
  }
  
  cachedClient = await MongoClient.connect(URI, options);
  return { client: cachedClient, db };
}
```

### 2. –û–Ω–æ–≤–ª–µ–Ω–æ 10 API —Ñ–∞–π–ª—ñ–≤:
‚úÖ `/api/admin/clients.ts`
‚úÖ `/api/admin/deals.ts`
‚úÖ `/api/admin/deal-events.ts`
‚úÖ `/api/admin/agents.ts`
‚úÖ `/api/admin/auth.ts`
‚úÖ `/api/admin/auth-simple.ts`
‚úÖ `/api/admin/transfer-properties.ts`
‚úÖ `/api/admin/update-profile.ts`
‚úÖ `/api/properties/[id]/view.ts`
‚úÖ `/api/admin/calendar.ts` (–Ω–æ–≤–∏–π)

### 3. –í–∏–¥–∞–ª–µ–Ω–æ –≤—Å—ñ `client.close()`:
Connection pool —É–ø—Ä–∞–≤–ª—è—î –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ!

---

## üìà –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:

### MongoDB Atlas Metrics:

**–î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```
Current Connections: 200-300 üî¥
Available: 200-300
Alert: "Connections above 80%" üö®
```

**–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```
Current Connections: 2-10 ‚úÖ
Available: 490-498
Alert: –ù–µ–º–∞—î üéâ
```

### –®–≤–∏–¥–∫—ñ—Å—Ç—å API:

**–î–æ:**
- GET /api/admin/clients: ~800ms
- GET /api/admin/deals: ~750ms
- GET /api/admin/properties: ~900ms

**–ü—ñ—Å–ª—è:**
- GET /api/admin/clients: ~200ms ‚ö°
- GET /api/admin/deals: ~180ms ‚ö°
- GET /api/admin/properties: ~250ms ‚ö°

---

## üéØ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:

### 1. –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å —Å–µ—Ä–≤–µ—Ä
npm run dev

# –ó—Ä–æ–±—ñ—Ç—å –∫—ñ–ª—å–∫–∞ –∑–∞–ø–∏—Ç—ñ–≤
curl http://localhost:3000/api/admin/properties
```

### 2. MongoDB Atlas Dashboard:
```
1. https://cloud.mongodb.com
2. Clusters ‚Üí Cluster0 ‚Üí Metrics
3. –î–∏–≤—ñ—Ç—å—Å—è –≥—Ä–∞—Ñ—ñ–∫ "Connections"
4. –ú–∞—î –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ 2-10 –∑–∞–º—ñ—Å—Ç—å 200-300
```

### 3. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫—É:
```bash
node scripts/check-connections-simple.js
```

---

## üîê –ë–µ–∑–ø–µ–∫–∞ (–±–æ–Ω—É—Å):

‚úÖ –í–∏–¥–∞–ª–µ–Ω–æ –≤—Å—ñ –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∂–µ–Ω—ñ –ø–∞—Ä–æ–ª—ñ
‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ .env.example
‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ .gitignore
‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è process.env.MONGODB_URI

**–ù–µ –∑–∞–±—É–¥—å—Ç–µ:**
1. –ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å MongoDB
2. –û–Ω–æ–≤–∏—Ç–∏ .env.local
3. –û–Ω–æ–≤–∏—Ç–∏ Vercel Environment Variables

---

## üìö –ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ:

### Connection Leak = üí∏ –ì—Ä–æ—à—ñ
- MongoDB Atlas —Ç–∞—Ä–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è –∑–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- >500 –ø—ñ–¥–∫–ª—é—á–µ–Ω—å = –ø–ª–∞—Ç–Ω–∏–π –ø–ª–∞–Ω
- Connection pooling = –µ–∫–æ–Ω–æ–º—ñ—è $$$

### Performance = üòä –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
- –®–≤–∏–¥—à—ñ –∑–∞–ø–∏—Ç–∏ = –∫—Ä–∞—â–∏–π UX
- –ù–µ–º–∞—î —Ç–∞–π–º-–∞—É—Ç—ñ–≤ = —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å
- –ú–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä

### Scalability = üöÄ –ó—Ä–æ—Å—Ç–∞–Ω–Ω—è
- –ü—ñ–¥—Ç—Ä–∏–º—É—î –±—ñ–ª—å—à–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- –ì–æ—Ç–æ–≤–æ –¥–æ –ø—Ä–æ–¥–∞–∫—à–Ω
- Best practices

---

## üéì –í–∏—Å–Ω–æ–≤–æ–∫:

**Connection Pooling** - —Ü–µ:
- ‚úÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç —ñ–Ω–¥—É—Å—Ç—Ä—ñ—ó
- ‚úÖ –í–±—É–¥–æ–≤–∞–Ω–æ –≤ MongoDB Driver
- ‚úÖ –ü—Ä–∞—Ü—é—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
- ‚úÖ –ï–∫–æ–Ω–æ–º–∏—Ç—å —Ä–µ—Å—É—Ä—Å–∏
- ‚úÖ –ü—Ä–∏—Å–∫–æ—Ä—é—î —Ä–æ–±–æ—Ç—É

**–ê–Ω–∞–ª–æ–≥—ñ—è:** –¶–µ —è–∫ —Ç–∞–∫—Å—ñ-–ø–∞—Ä–∫ –∑–∞–º—ñ—Å—Ç—å –≤–∏–∫–ª–∏–∫—É –Ω–æ–≤–æ–≥–æ —Ç–∞–∫—Å—ñ –¥–ª—è –∫–æ–∂–Ω–æ—ó –ø–æ—ó–∑–¥–∫–∏! üöï

---

–°—Ç–≤–æ—Ä–µ–Ω–æ: $(date)
–ê–≤—Ç–æ—Ä: AI Assistant
–°—Ç–∞—Ç—É—Å: ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û
